<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>To'lov Tasdiqlash</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    .payment-card {
      transition: all 0.3s;
      border-left: 4px solid #ffc107;
    }

    .payment-card:hover {
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .payment-card.approved {
      border-left-color: #28a745;
      opacity: 0.7;
    }

    .payment-card.rejected {
      border-left-color: #dc3545;
      opacity: 0.7;
    }

    .stat-box {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .stat-box.pending {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .stat-box.approved {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }

    .stat-box.rejected {
      background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="/dashboard.html">
        <i class="bi bi-truck"></i> Logistics System
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item">
            <a class="nav-link" href="/dashboard.html">
              <i class="bi bi-house"></i> Dashboard
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/subscriptions.html">
              <i class="bi bi-credit-card"></i> Obunalar
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="/payment-approvals.html">
              <i class="bi bi-check2-circle"></i> To'lov Tasdiqlash
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/vip.html">
              <i class="bi bi-star-fill"></i> VIP A'zolar
            </a>
          </li>
        </ul>
        <div class="d-flex">
          <button class="btn btn-outline-light btn-sm" onclick="logout()">
            <i class="bi bi-box-arrow-right"></i> Chiqish
          </button>
        </div>
      </div>
    </div>
  </nav>

  <div class="container-fluid mt-4">
    <!-- Statistics -->
    <div class="row mb-4">
      <div class="col-md-3">
        <div class="stat-box pending">
          <h6><i class="bi bi-hourglass-split"></i> Kutilmoqda</h6>
          <h2 id="pendingCount">0</h2>
          <small>Tasdiqlash kerak</small>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stat-box approved">
          <h6><i class="bi bi-check-circle"></i> Tasdiqlangan</h6>
          <h2 id="approvedCount">0</h2>
          <small>Obuna yaratilgan</small>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stat-box rejected">
          <h6><i class="bi bi-x-circle"></i> Rad etilgan</h6>
          <h2 id="rejectedCount">0</h2>
          <small>To'lov rad etildi</small>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stat-box">
          <h6><i class="bi bi-currency-dollar"></i> Jami summa</h6>
          <h2 id="totalAmount">0</h2>
          <small>so'm (Tasdiqlangan)</small>
        </div>
      </div>
    </div>

    <!-- Filter -->
    <div class="card mb-4">
      <div class="card-body">
        <div class="row">
          <div class="col-md-3">
            <select class="form-select" id="filterStatus">
              <option value="pending">Kutilmoqda</option>
              <option value="approved">Tasdiqlangan</option>
              <option value="rejected">Rad etilgan</option>
              <option value="">Barchasi</option>
            </select>
          </div>
          <div class="col-md-3">
            <button class="btn btn-primary" onclick="loadPayments()">
              <i class="bi bi-search"></i> Qidirish
            </button>
            <button class="btn btn-secondary" onclick="loadPayments()">
              <i class="bi bi-arrow-clockwise"></i> Yangilash
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Payments List -->
    <div class="row" id="paymentsList">
      <div class="col-12 text-center">
        <div class="spinner-border" role="status">
          <span class="visually-hidden">Yuklanmoqda...</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Approve/Reject Modal -->
  <div class="modal fade" id="actionModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="actionModalTitle">To'lovni Tasdiqlash</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="actionForm">
            <input type="hidden" id="actionPaymentId">
            <input type="hidden" id="actionType">
            <div class="mb-3">
              <label class="form-label">Admin Izoh</label>
              <textarea class="form-control" id="adminNotes" rows="3" placeholder="Izoh (ixtiyoriy)"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Yopish</button>
          <button type="button" class="btn btn-primary" onclick="submitAction()" id="actionSubmitBtn">Tasdiqlash</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const API_BASE = '/api';
    const token = localStorage.getItem('token');

    if (!token) {
      window.location.href = '/index.html';
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadStats();
      loadPayments();

      // Auto refresh every 30 seconds
      setInterval(() => {
        loadStats();
        loadPayments();
      }, 30000);
    });

    async function loadStats() {
      try {
        const response = await fetch(`${API_BASE}/payment-manual/stats`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        const data = await response.json();

        if (data.success) {
          document.getElementById('pendingCount').textContent = data.stats.pending;
          document.getElementById('approvedCount').textContent = data.stats.approved;
          document.getElementById('rejectedCount').textContent = data.stats.rejected;
          document.getElementById('totalAmount').textContent = data.stats.total_amount_approved.toLocaleString();
        }
      } catch (error) {
        console.error('Stats load error:', error);
      }
    }

    async function loadPayments() {
      const status = document.getElementById('filterStatus').value;
      let url = `${API_BASE}/payment-manual/all?limit=50`;

      if (status) {
        url += `&status=${status}`;
      }

      try {
        const response = await fetch(url, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        const data = await response.json();

        if (data.success) {
          renderPayments(data.payments);
        }
      } catch (error) {
        console.error('Payments load error:', error);
      }
    }

    function renderPayments(payments) {
      const container = document.getElementById('paymentsList');

      if (payments.length === 0) {
        container.innerHTML = '<div class="col-12"><p class="text-center text-muted">To\'lovlar topilmadi</p></div>';
        return;
      }

      container.innerHTML = payments.map(payment => {
        const statusBadge = payment.status === 'approved'
          ? '<span class="badge bg-success">Tasdiqlangan</span>'
          : payment.status === 'rejected'
          ? '<span class="badge bg-danger">Rad etilgan</span>'
          : '<span class="badge bg-warning">Kutilmoqda</span>';

        const planBadge = payment.plan_type === 'weekly'
          ? '<span class="badge bg-primary">Haftalik (30,000)</span>'
          : '<span class="badge bg-info">Oylik (70,000)</span>';

        return `
          <div class="col-md-6 mb-3">
            <div class="card payment-card ${payment.status}">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <div>
                    <h5 class="card-title mb-1">${payment.full_name || 'N/A'}</h5>
                    <small class="text-muted">@${payment.username || 'N/A'} | ID: ${payment.telegram_user_id}</small>
                  </div>
                  <div class="text-end">
                    ${statusBadge}
                  </div>
                </div>

                <hr>

                <div class="row mb-2">
                  <div class="col-6">
                    <strong>Reja:</strong><br>
                    ${planBadge}
                  </div>
                  <div class="col-6">
                    <strong>Summa:</strong><br>
                    <span class="h5">${payment.amount.toLocaleString()} so'm</span>
                  </div>
                </div>

                ${payment.payment_proof_text ? `
                  <div class="mb-2">
                    <strong>Chek ma'lumoti:</strong><br>
                    <small class="text-muted">${payment.payment_proof_text}</small>
                  </div>
                ` : ''}

                ${payment.referrer_code ? `
                  <div class="mb-2">
                    <strong>Referral:</strong> <code>${payment.referrer_code}</code>
                  </div>
                ` : ''}

                ${payment.admin_notes ? `
                  <div class="mb-2">
                    <strong>Admin izoh:</strong><br>
                    <small class="text-info">${payment.admin_notes}</small>
                  </div>
                ` : ''}

                <small class="text-muted">
                  <i class="bi bi-clock"></i> ${new Date(payment.created_at).toLocaleString('uz-UZ')}
                </small>

                ${payment.status === 'pending' ? `
                  <hr>
                  <div class="d-flex gap-2">
                    <button class="btn btn-success flex-fill" onclick="openActionModal(${payment.id}, 'approve')">
                      <i class="bi bi-check-circle"></i> Tasdiqlash
                    </button>
                    <button class="btn btn-danger flex-fill" onclick="openActionModal(${payment.id}, 'reject')">
                      <i class="bi bi-x-circle"></i> Rad etish
                    </button>
                  </div>
                ` : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function openActionModal(paymentId, actionType) {
      document.getElementById('actionPaymentId').value = paymentId;
      document.getElementById('actionType').value = actionType;

      if (actionType === 'approve') {
        document.getElementById('actionModalTitle').textContent = 'To\'lovni Tasdiqlash';
        document.getElementById('actionSubmitBtn').textContent = 'Tasdiqlash';
        document.getElementById('actionSubmitBtn').className = 'btn btn-success';
      } else {
        document.getElementById('actionModalTitle').textContent = 'To\'lovni Rad Etish';
        document.getElementById('actionSubmitBtn').textContent = 'Rad Etish';
        document.getElementById('actionSubmitBtn').className = 'btn btn-danger';
      }

      document.getElementById('adminNotes').value = '';
      new bootstrap.Modal(document.getElementById('actionModal')).show();
    }

    async function submitAction() {
      const paymentId = document.getElementById('actionPaymentId').value;
      const actionType = document.getElementById('actionType').value;
      const adminNotes = document.getElementById('adminNotes').value;

      try {
        const response = await fetch(`${API_BASE}/payment-manual/${actionType}/${paymentId}`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ admin_notes: adminNotes })
        });

        const result = await response.json();

        if (result.success) {
          alert(actionType === 'approve' ? 'To\'lov tasdiqlandi!' : 'To\'lov rad etildi!');
          bootstrap.Modal.getInstance(document.getElementById('actionModal')).hide();
          loadStats();
          loadPayments();
        } else {
          alert('Xatolik: ' + result.error);
        }
      } catch (error) {
        console.error('Action submit error:', error);
        alert('Xatolik yuz berdi');
      }
    }

    function logout() {
      localStorage.removeItem('token');
      window.location.href = '/index.html';
    }
  </script>
</body>
</html>
