<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ommaviy Xabar - Logistika Filter</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/dashboard.html">
                <i class="bi bi-truck"></i> Logistika Filter
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/dashboard.html">
                            <i class="bi bi-house"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/messages.html">
                            <i class="bi bi-envelope"></i> E'lonlar
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/phones.html">
                            <i class="bi bi-telephone"></i> Telefon Raqamlar
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/blocked.html">
                            <i class="bi bi-ban"></i> Bloklangan
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/groups.html">
                            <i class="bi bi-people"></i> Guruhlar
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/sms.html">
                            <i class="bi bi-phone-vibrate"></i> SMS
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/auto-reply.html">
                            <i class="bi bi-reply-all"></i> Auto-Reply
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/broadcast.html">
                            <i class="bi bi-megaphone"></i> Ommaviy Xabar
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/subscriptions.html">
                            <i class="bi bi-credit-card"></i> Obunalar
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/vip.html">
                            <i class="bi bi-star-fill"></i> VIP A'zolar
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/settings.html">
                            <i class="bi bi-gear"></i> Sozlamalar
                        </a>
                    </li>
                </ul>
                <div class="d-flex align-items-center text-white">
                    <span class="me-3" id="userInfo">
                        <i class="bi bi-person-circle"></i> <span id="username"></span>
                    </span>
                    <button class="btn btn-outline-light btn-sm" id="logoutBtn">
                        <i class="bi bi-box-arrow-right"></i> Chiqish
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid mt-4">

        <!-- Statistika Kartalar -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-white bg-primary">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-title">Jami Yuborilgan</h6>
                                <h2 id="totalSent">0</h2>
                            </div>
                            <i class="bi bi-send-check" style="font-size: 3rem; opacity: 0.3;"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-success">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-title">Scheduled</h6>
                                <h2 id="totalScheduled">0</h2>
                            </div>
                            <i class="bi bi-calendar-check" style="font-size: 3rem; opacity: 0.3;"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-info">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-title">Lichka Javoblar</h6>
                                <h2 id="totalPrivateReplies">0</h2>
                            </div>
                            <i class="bi bi-chat-dots" style="font-size: 3rem; opacity: 0.3;"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-warning">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-title">Guruhlar</h6>
                                <h2 id="totalBroadcastGroups">0</h2>
                            </div>
                            <i class="bi bi-people" style="font-size: 3rem; opacity: 0.3;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Session Boshqaruvi -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="bi bi-phone"></i> Auto-Reply Session Boshqaruvi
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-4">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0">
                                        <div class="rounded-circle p-3" id="sessionStatusIcon" style="background-color: #f8f9fa;">
                                            <i class="bi bi-phone-vibrate" style="font-size: 2rem; color: #6c757d;"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h6 class="text-muted mb-1" style="font-size: 0.85rem;">Session Holati</h6>
                                        <h4 class="mb-0" id="sessionStatusText">Tekshirilmoqda...</h4>
                                        <small id="sessionPhoneNumber" class="text-muted"></small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-8 text-end">
                                <div id="sessionConnectedActions" style="display: none;">
                                    <button class="btn btn-outline-danger" onclick="deleteSession()">
                                        <i class="bi bi-trash"></i> Session O'chirish
                                    </button>
                                    <button class="btn btn-outline-warning ms-2" onclick="restartSession()">
                                        <i class="bi bi-arrow-clockwise"></i> Qayta Ishga Tushirish
                                    </button>
                                </div>
                                <div id="sessionDisconnectedActions" style="display: none;">
                                    <button class="btn btn-primary" onclick="showSessionModal()">
                                        <i class="bi bi-plus-circle"></i> Yangi Session Yaratish
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Session Info (when connected) -->
                        <div id="sessionInfo" style="display: none;" class="mt-3 pt-3 border-top">
                            <div class="row">
                                <div class="col-md-3">
                                    <small class="text-muted">Session Start:</small>
                                    <p id="sessionStartTime">-</p>
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted">Auto-Reply:</small>
                                    <p id="autoReplyStatus">-</p>
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted">Queue:</small>
                                    <p id="queueSize">-</p>
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted">Xatolar (5 daqiqa):</small>
                                    <p id="recentErrors">-</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Warning -->
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i>
            <strong>OGOHLANTIRISH:</strong> Bu funksiya <strong>FAQAT AUTO-REPLY SESSION</strong> guruhlariga xabar yuboradi.
            Asosiy monitoring session xavfsiz!
        </div>

        <!-- Status Check -->
        <div id="statusCheck" class="alert alert-danger" style="display: none;">
            <i class="bi bi-x-circle"></i>
            <strong>XATO:</strong> Auto-reply session ulanmagan.
            <button class="btn btn-sm btn-light ms-3" onclick="showSessionModal()">
                <i class="bi bi-plus-circle"></i> Session Yaratish
            </button>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs mb-3" id="broadcastTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="instant-tab" data-bs-toggle="tab" data-bs-target="#instant" type="button">
                    <i class="bi bi-send"></i> Darhol Yuborish
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="scheduled-tab" data-bs-toggle="tab" data-bs-target="#scheduled" type="button">
                    <i class="bi bi-calendar-check"></i> Rejalashtirilgan
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="private-tab" data-bs-toggle="tab" data-bs-target="#private" type="button">
                    <i class="bi bi-chat-dots"></i> Lichka Javob
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="broadcastTabContent">
            <!-- Instant Broadcast Tab -->
            <div class="tab-pane fade show active" id="instant" role="tabpanel">
                <!-- Broadcast Form -->
                <div class="card" id="broadcastForm">
            <div class="card-body">
                <h5 class="card-title">Xabar Matn</h5>
                <textarea class="form-control message-textarea" id="messageText" placeholder="Xabar matni..."></textarea>

                <div class="mt-3">
                    <h6>Broadcast Usuli:</h6>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="broadcastMode" id="modeSingle" value="single" checked onchange="updateBroadcastMode()">
                        <label class="form-check-label" for="modeSingle">
                            <strong>üì± Bitta Session</strong> - .env dagi asosiy session
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="broadcastMode" id="modeMulti" value="multi" onchange="updateBroadcastMode()">
                        <label class="form-check-label" for="modeMulti">
                            <strong>üöÄ Ko'p Session</strong> - Barcha faol sessionlar navbat bilan (<span id="sessionCount">0</span> ta session)
                        </label>
                    </div>
                    <div class="alert alert-info mt-2" style="font-size: 0.85rem;">
                        <i class="bi bi-info-circle"></i> Ko'p session rejimida barcha faol sessionlar navbat bilan xabar yuboradi (Birinchi akkaunt ‚Üí Ikkinchi akkaunt ‚Üí ...). <strong>Interval: 8 soniya</strong>
                    </div>
                </div>

                <div class="mt-3">
                    <h6>Yuborish Tezligi:</h6>
                    <div class="alert alert-info mb-3">
                        <small><i class="bi bi-info-circle"></i> <strong>Ko'p session:</strong> 8 soniya har xabar orasida (FLOOD_WAIT dan qochish uchun) | <strong>Bitta session:</strong> Tanlangan tezlikda</small>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="speed" id="speedSafe" value="safe" checked>
                        <label class="form-check-label" for="speedSafe">
                            <strong>‚úÖ Xavfsiz</strong> (20 guruh/daqiqa)
                        </label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="speed" id="speedFast" value="fast">
                        <label class="form-check-label" for="speedFast">
                            <strong>‚ö° O'rtacha</strong> (30 guruh/daqiqa)
                        </label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="speed" id="speedTurbo" value="turbo">
                        <label class="form-check-label" for="speedTurbo">
                            <strong>üöÄ Tez</strong> (40 guruh/daqiqa - muzlash xavfi!)
                        </label>
                    </div>
                </div>

                <div class="mt-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="loopMode">
                        <label class="form-check-label" for="loopMode">
                            <strong>üîÅ Tsiklik rejim</strong> - Tugagach, qaytadan boshlash (to'xtatmaguncha davom etadi)
                        </label>
                    </div>
                    <div class="alert alert-warning mt-2" style="font-size: 0.85rem;">
                        <i class="bi bi-exclamation-triangle"></i> <strong>Diqqat:</strong> Tsiklik rejimda xabar doimiy ravishda yuboriladi. Cheklangan guruhlar skip qilinadi.
                    </div>
                </div>

                <div class="mt-4 d-flex gap-2">
                    <button class="btn btn-broadcast btn-primary flex-grow-1" onclick="startBroadcast()">
                        <i class="bi bi-send"></i> Yuborishni Boshlash
                    </button>
                </div>
            </div>
        </div>

                <!-- Progress Card -->
                <div class="card progress-card" id="progressCard">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-clock-history"></i> Jarayon</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="stat-box">
                            <h3 id="totalGroups" class="text-primary">0</h3>
                            <p>Jami guruhlar</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-box">
                            <h3 id="sentCount" class="text-success">0</h3>
                            <p>Yuborildi</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-box">
                            <h3 id="failedCount" class="text-danger">0</h3>
                            <p>Muvaffaqiyatsiz</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-box">
                            <h3 id="restrictedCount" class="text-warning">0</h3>
                            <p>Cheklangan</p>
                        </div>
                    </div>
                </div>

                <div class="mt-3">
                    <div class="progress" style="height: 30px;">
                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                             role="progressbar" style="width: 0%">0%</div>
                    </div>
                </div>

                <div class="mt-3">
                    <p><strong>Xabar:</strong> <span id="currentMessage">-</span></p>
                    <p><strong>Qolgan:</strong> <span id="remainingCount">-</span></p>
                    <p id="loopCountDisplay" style="display: none;"><strong>üîÅ Tsikl soni:</strong> <span id="loopCount">0</span></p>
                </div>

                <div class="mt-3">
                    <button class="btn btn-stop btn-danger" onclick="stopBroadcast()">
                        <i class="bi bi-stop-circle"></i> To'xtatish
                    </button>
                </div>

                <!-- Restricted Groups -->
                <div class="mt-3" id="restrictedGroupsSection" style="display: none;">
                    <h6>Cheklangan Guruhlar (keyinroq qayta uriniladi):</h6>
                    <div class="restricted-groups-list" id="restrictedGroupsList">
                        <!-- Dynamically populated -->
                    </div>
                </div>
            </div>
                </div>
                <!-- End Progress Card -->

            </div>
            <!-- End Instant Broadcast Tab -->

            <!-- Scheduled Broadcast Tab -->
            <div class="tab-pane fade" id="scheduled" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-calendar-plus"></i> Yangi Rejalashtirilgan Xabar</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Xabar Matni</label>
                            <textarea class="form-control" id="scheduledMessage" rows="5" placeholder="Avtomatik yuboriladi gan xabar..."></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Interval</label>
                                <input type="number" class="form-control" id="scheduleInterval" value="30" min="1">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Birlik</label>
                                <select class="form-select" id="scheduleUnit">
                                    <option value="minutes">Daqiqa</option>
                                    <option value="hours">Soat</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-primary" onclick="addSchedule()">
                                <i class="bi bi-plus-circle"></i> Qo'shish
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-list-check"></i> Rejalashtirilgan Xabarlar</h5>
                    </div>
                    <div class="card-body">
                        <div id="schedulesList">
                            <p class="text-muted">Yuklanmoqda...</p>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End Scheduled Broadcast Tab -->

            <!-- Private Message Auto-Reply Tab -->
            <div class="tab-pane fade" id="private" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-chat-dots"></i> Lichka Avtomatik Javob</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            <strong>Qanday ishlaydi:</strong> Kimdir auto-reply sessionga lichkada yozsa, avtomatik javob yuboriladi. @yoldauz guruhiga qo'shilishga undaydi.
                        </div>

                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="privateReplyEnabled" style="width: 60px; height: 30px;">
                                <label class="form-check-label ms-2" for="privateReplyEnabled">
                                    <strong>Lichka Javobni Yoqish</strong>
                                </label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Javob Shabloni</label>
                            <textarea class="form-control" id="privateReplyTemplate" rows="15"></textarea>
                            <small class="text-muted">Bu shablon lichkaga yozgan userga yuboriladi</small>
                        </div>

                        <div class="mb-3">
                            <button class="btn btn-primary" onclick="savePrivateReply()">
                                <i class="bi bi-save"></i> Saqlash
                            </button>
                            <button class="btn btn-outline-secondary ms-2" onclick="loadDefaultTemplate()">
                                <i class="bi bi-arrow-clockwise"></i> Default Shablon
                            </button>
                        </div>

                        <div class="alert alert-success">
                            <strong>Javob berilganlar:</strong> <span id="repliedUsersCount">0</span> ta user
                            <button class="btn btn-sm btn-outline-danger ms-3" onclick="clearRepliedUsers()">
                                <i class="bi bi-trash"></i> Tozalash
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End Private Message Auto-Reply Tab -->

        </div>
        <!-- End Tab Content -->

        <!-- Session Creation Modal -->
        <div class="modal fade" id="sessionModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-person-plus"></i> Auto-Reply Session Yaratish
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Step 1: Phone Number -->
                        <div id="sessionStep1" class="session-step">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i>
                                <strong>Diqqat:</strong> Monitoring session'dan BOSHQA telefon raqam kiriting!
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Telefon Raqam</label>
                                <input type="text" class="form-control" id="phoneNumber"
                                       placeholder="+998901234567" />
                                <small class="text-muted">Misol: +998901234567 (+ bilan boshlang)</small>
                            </div>
                            <button class="btn btn-primary w-100" onclick="sendCode()">
                                <i class="bi bi-send"></i> SMS Kod Yuborish
                            </button>
                        </div>

                        <!-- Step 2: Code Verification -->
                        <div id="sessionStep2" class="session-step" style="display: none;">
                            <div class="alert alert-success">
                                <i class="bi bi-check-circle"></i>
                                SMS kod yuborildi: <strong id="sentPhone"></strong>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">SMS Kod</label>
                                <input type="text" class="form-control" id="smsCode"
                                       placeholder="12345" />
                            </div>
                            <div class="mb-3">
                                <label class="form-label">2FA Parol (ixtiyoriy)</label>
                                <input type="password" class="form-control" id="password2fa"
                                       placeholder="Agar 2FA yoqilgan bo'lsa" />
                                <small class="text-muted">2FA bo'lmasa bo'sh qoldiring</small>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-secondary flex-grow-1" onclick="backToStep1()">
                                    <i class="bi bi-arrow-left"></i> Orqaga
                                </button>
                                <button class="btn btn-primary flex-grow-1" onclick="verifyCode()">
                                    <i class="bi bi-check"></i> Tasdiqlash
                                </button>
                            </div>
                        </div>

                        <!-- Step 3: Success -->
                        <div id="sessionStep3" class="session-step" style="display: none;">
                            <div class="alert alert-success">
                                <i class="bi bi-check-circle"></i>
                                <strong>Muvaffaqiyatli!</strong> Session yaratildi.
                            </div>
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6>Account Ma'lumotlari:</h6>
                                    <p class="mb-1"><strong>Ism:</strong> <span id="accountName"></span></p>
                                    <p class="mb-1"><strong>Telefon:</strong> <span id="accountPhone"></span></p>
                                    <p class="mb-0"><strong>ID:</strong> <span id="accountId"></span></p>
                                </div>
                            </div>
                            <div class="mt-3">
                                <button class="btn btn-success w-100" onclick="saveAndRestart()">
                                    <i class="bi bi-save"></i> Saqlash va Restart Qilish
                                </button>
                            </div>
                        </div>

                        <!-- Loading -->
                        <div id="sessionLoading" style="display: none;">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status"></div>
                                <p class="mt-2">Kutilmoqda...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let progressInterval = null;

        // Load session count on page load
        async function loadSessionCount() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/broadcast/sessions/list', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('sessionCount').textContent = data.active || 0;
                }
            } catch (error) {
                console.error('Load session count error:', error);
            }
        }

        // Update broadcast mode (disable speed for multi-session)
        function updateBroadcastMode() {
            const mode = document.querySelector('input[name="broadcastMode"]:checked').value;
            const speedRadios = document.querySelectorAll('input[name="speed"]');

            if (mode === 'multi') {
                // Disable speed selection for multi-session (fixed 3s)
                speedRadios.forEach(radio => {
                    radio.disabled = true;
                    radio.parentElement.style.opacity = '0.5';
                });
            } else {
                // Enable speed selection for single session
                speedRadios.forEach(radio => {
                    radio.disabled = false;
                    radio.parentElement.style.opacity = '1';
                });
            }
        }

        // Load session count on page load
        loadSessionCount();
        setInterval(loadSessionCount, 10000); // Refresh every 10 seconds

        // Check status on load
        window.addEventListener('DOMContentLoaded', async () => {
            await checkStatus();
        });

        async function checkStatus() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/broadcast/status', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    console.warn('Status API unavailable, skipping...');
                    return true; // Continue anyway
                }

                const data = await response.json();

                // Update session status UI (if data is valid)
                if (data && typeof data === 'object') {
                    updateSessionStatus(data);

                    // YAXSHILANDI: Formni faqat warning ko'rsatamiz, yashirmaymiz
                    // Sabab: Ko'p session rejimida bitta session ulanmagan bo'lsa ham ishlatish mumkin
                    if (!data.isConnected) {
                        const statusCheck = document.getElementById('statusCheck');
                        if (statusCheck) {
                            statusCheck.style.display = 'block';
                        }
                        // Form yashirilmaydi - foydalanuvchi ko'p session rejimini tanlashi mumkin
                    }

                    // Check if broadcast is already in progress
                    if (data.broadcastInProgress) {
                        showProgress();
                        startProgressPolling();
                    }

                    // Load statistics
                    loadStatistics();
                }

                return true;

            } catch (error) {
                console.error('Status check error:', error);
                // Don't alert - just log and continue
                return true; // Continue anyway
            }
        }

        // Update session status display
        function updateSessionStatus(data) {
            try {
                const statusIcon = document.getElementById('sessionStatusIcon');
                const statusText = document.getElementById('sessionStatusText');
                const phoneNumber = document.getElementById('sessionPhoneNumber');
                const sessionInfo = document.getElementById('sessionInfo');
                const connectedActions = document.getElementById('sessionConnectedActions');
                const disconnectedActions = document.getElementById('sessionDisconnectedActions');

                // Check if elements exist
                if (!statusIcon || !statusText) {
                    console.warn('Session status elements not found');
                    return;
                }

                if (data.isConnected) {
                    // Connected state
                    statusIcon.innerHTML = '<i class="bi bi-check-circle-fill text-success" style="font-size: 2rem;"></i>';
                    statusIcon.style.backgroundColor = '#d4edda';
                    statusText.textContent = 'Ulangan';
                    statusText.className = 'mb-0 text-success';
                    if (phoneNumber) phoneNumber.textContent = data.phoneNumber || '';

                    if (connectedActions) connectedActions.style.display = 'block';
                    if (disconnectedActions) disconnectedActions.style.display = 'none';
                    if (sessionInfo) sessionInfo.style.display = 'block';

                    // Update session info (with null checks)
                    const sessionStartTime = document.getElementById('sessionStartTime');
                    const autoReplyStatus = document.getElementById('autoReplyStatus');
                    const queueSize = document.getElementById('queueSize');
                    const recentErrors = document.getElementById('recentErrors');

                    if (sessionStartTime) sessionStartTime.textContent = data.sessionStart || '-';
                    if (autoReplyStatus) autoReplyStatus.textContent = data.autoReplyEnabled ? '‚úÖ Yoqilgan' : '‚ùå O\'chirilgan';
                    if (queueSize) queueSize.textContent = data.queueSize || '0';
                    if (recentErrors) recentErrors.textContent = data.recentErrors || '0';

                } else {
                    // Disconnected state
                    statusIcon.innerHTML = '<i class="bi bi-x-circle-fill text-danger" style="font-size: 2rem;"></i>';
                    statusIcon.style.backgroundColor = '#f8d7da';
                    statusText.textContent = 'Ulanmagan';
                    statusText.className = 'mb-0 text-danger';
                    if (phoneNumber) phoneNumber.textContent = '';

                    if (connectedActions) connectedActions.style.display = 'none';
                    if (disconnectedActions) disconnectedActions.style.display = 'block';
                    if (sessionInfo) sessionInfo.style.display = 'none';
                }
            } catch (error) {
                console.error('updateSessionStatus error:', error);
            }
        }

        async function loadStatistics() {
            try {
                const token = localStorage.getItem('token');

                // Get progress for total sent
                const progressRes = await fetch('/api/broadcast/progress', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const progressData = await progressRes.json();
                document.getElementById('totalSent').textContent = progressData.sent || 0;

                // Get scheduled broadcasts count
                const schedulesRes = await fetch('/api/broadcast/schedule/list', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const schedulesData = await schedulesRes.json();
                document.getElementById('totalScheduled').textContent = schedulesData.schedules?.length || 0;

                // Get private reply count
                const privateRes = await fetch('/api/broadcast/private-reply/settings', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const privateData = await privateRes.json();
                document.getElementById('totalPrivateReplies').textContent = privateData.settings?.repliedCount || 0;

                // Get status for groups count
                const statusRes = await fetch('/api/broadcast/status', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const statusData = await statusRes.json();
                document.getElementById('totalBroadcastGroups').textContent = statusData.broadcastProgress?.total || 0;

            } catch (error) {
                console.error('Statistics load error:', error);
            }
        }

        async function startBroadcast() {
            const message = document.getElementById('messageText').value.trim();
            const speed = document.querySelector('input[name="speed"]:checked').value;
            const loopCheckbox = document.getElementById('loopMode');
            const loop = loopCheckbox ? loopCheckbox.checked : false;
            const mode = document.querySelector('input[name="broadcastMode"]:checked').value;

            console.log('üîç START BROADCAST DEBUG:');
            console.log('   Mode:', mode);
            console.log('   Loop checkbox element:', loopCheckbox);
            console.log('   Loop checkbox.checked:', loop);
            console.log('   Message:', message.substring(0, 50));
            console.log('   Speed:', speed);

            if (!message) {
                alert('Xabar matnini kiriting!');
                return;
            }

            let confirmMsg = `Haqiqatan ham ${message.length} belgili xabarni ${mode === 'multi' ? 'barcha sessionlardagi' : ''} barcha guruhlarga yubormoqchimisiz?`;
            if (loop) {
                confirmMsg += '\n\nüîÅ TSIKLIK REJIM YOQILGAN - Xabar to\'xtatmaguncha davom etadi!';
            }

            if (!confirm(confirmMsg)) {
                return;
            }

            try {
                const token = localStorage.getItem('token');

                // Choose endpoint based on mode
                const endpoint = mode === 'multi' ? '/api/broadcast/multi-send' : '/api/broadcast/send';
                const payload = mode === 'multi'
                    ? { message, loop }  // Multi-session uses fixed 3s interval
                    : { message, speed, loop };  // Single session uses speed setting

                console.log('üì§ Sending to:', endpoint);
                console.log('üì§ Payload:', payload);

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error);
                }

                let alertMsg = `‚úÖ Broadcast boshlandi!\nJami: ${data.total} guruh`;
                if (mode === 'multi') {
                    alertMsg += `\nSessionlar: ${data.sessions} ta`;
                } else if (data.restricted) {
                    alertMsg += `\nCheklangan: ${data.restricted} guruh`;
                }
                if (loop) {
                    alertMsg += '\n\nüîÅ Tsiklik rejim aktiv - guruhlar tugagach qayta boshlaydi';
                }
                alert(alertMsg);

                showProgress();
                startProgressPolling(mode);

            } catch (error) {
                console.error('Broadcast error:', error);
                alert('Xatolik: ' + error.message);
            }
        }

        async function stopBroadcast() {
            if (!confirm('Haqiqatan ham to\'xtatmoqchimisiz?')) {
                return;
            }

            try {
                const token = localStorage.getItem('token');
                const mode = document.querySelector('input[name="broadcastMode"]:checked').value;
                const endpoint = mode === 'multi' ? '/api/broadcast/multi-stop' : '/api/broadcast/stop';

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    alert(`‚úÖ To'xtatildi!\nYuborildi: ${data.sent}\nBekor qilindi: ${data.cancelled}`);
                    hideProgress();
                    stopProgressPolling();
                } else {
                    alert(data.message);
                }

            } catch (error) {
                console.error('Stop error:', error);
                alert('Xatolik: ' + error.message);
            }
        }

        function startProgressPolling(mode = 'single') {
            if (progressInterval) {
                clearInterval(progressInterval);
            }

            progressInterval = setInterval(async () => {
                await updateProgress(mode);
            }, 1000);
        }

        function stopProgressPolling() {
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }
        }

        async function updateProgress(mode = 'single') {
            try {
                const token = localStorage.getItem('token');
                const endpoint = mode === 'multi' ? '/api/broadcast/multi-progress' : '/api/broadcast/progress';

                const response = await fetch(endpoint, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (!data.success) {
                    return;
                }

                // Update stats
                document.getElementById('totalGroups').textContent = data.total || 0;
                document.getElementById('sentCount').textContent = data.sent || 0;
                document.getElementById('failedCount').textContent = data.failed || 0;
                document.getElementById('restrictedCount').textContent = data.restricted || 0;
                document.getElementById('remainingCount').textContent = data.remaining || 0;
                document.getElementById('currentMessage').textContent = data.currentMessage || '-';

                // Update loop count if > 0
                if (data.loopCount > 0) {
                    document.getElementById('loopCountDisplay').style.display = 'block';
                    document.getElementById('loopCount').textContent = data.loopCount;
                } else {
                    document.getElementById('loopCountDisplay').style.display = 'none';
                }

                // Update progress bar
                const percentage = data.total > 0 ? Math.round((data.sent / data.total) * 100) : 0;
                document.getElementById('progressBar').style.width = percentage + '%';
                document.getElementById('progressBar').textContent = percentage + '%';

                // Update restricted groups
                if (data.restrictedGroups && data.restrictedGroups.length > 0) {
                    document.getElementById('restrictedGroupsSection').style.display = 'block';
                    const list = data.restrictedGroups.map(g =>
                        `<div class="small">${g.chatId} - ${g.reason} - ${new Date(g.until).toLocaleTimeString('uz-UZ')}</div>`
                    ).join('');
                    document.getElementById('restrictedGroupsList').innerHTML = list;
                } else {
                    document.getElementById('restrictedGroupsSection').style.display = 'none';
                }

                // If completed, stop polling
                if (!data.inProgress) {
                    stopProgressPolling();
                    alert(`‚úÖ Broadcast tugadi!\nYuborildi: ${data.sent}/${data.total}`);
                    setTimeout(() => {
                        hideProgress();
                    }, 5000);
                }

            } catch (error) {
                console.error('Progress update error:', error);
            }
        }

        function showProgress() {
            document.getElementById('broadcastForm').style.display = 'none';
            document.getElementById('progressCard').classList.add('active');
        }

        function hideProgress() {
            document.getElementById('broadcastForm').style.display = 'block';
            document.getElementById('progressCard').classList.remove('active');
        }

        /**
         * ============================================
         * SESSION CREATION FUNCTIONS
         * ============================================
         */

        let sessionModal = null;
        let currentSessionString = '';

        function showSessionModal() {
            if (!sessionModal) {
                sessionModal = new bootstrap.Modal(document.getElementById('sessionModal'));
            }

            // Reset to step 1
            document.getElementById('sessionStep1').style.display = 'block';
            document.getElementById('sessionStep2').style.display = 'none';
            document.getElementById('sessionStep3').style.display = 'none';
            document.getElementById('sessionLoading').style.display = 'none';

            // Clear inputs
            document.getElementById('phoneNumber').value = '';
            document.getElementById('smsCode').value = '';
            document.getElementById('password2fa').value = '';

            sessionModal.show();
        }

        function showLoading(show) {
            document.getElementById('sessionLoading').style.display = show ? 'block' : 'none';
            document.getElementById('sessionStep1').style.display = show ? 'none' : 'block';
            document.getElementById('sessionStep2').style.display = 'none';
            document.getElementById('sessionStep3').style.display = 'none';
        }

        async function sendCode() {
            const phoneNumber = document.getElementById('phoneNumber').value.trim();

            if (!phoneNumber) {
                alert('Telefon raqam kiriting!');
                return;
            }

            if (!phoneNumber.startsWith('+')) {
                alert('Telefon raqam + belgisi bilan boshlanishi kerak!\nMisol: +998901234567');
                return;
            }

            try {
                showLoading(true);

                const token = localStorage.getItem('token');
                const response = await fetch('/api/broadcast/session/create-step1', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ phoneNumber })
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error);
                }

                // Move to step 2
                document.getElementById('sentPhone').textContent = phoneNumber;
                document.getElementById('sessionStep1').style.display = 'none';
                document.getElementById('sessionStep2').style.display = 'block';
                document.getElementById('sessionLoading').style.display = 'none';

                alert('‚úÖ SMS kod yuborildi! Telefoningizni tekshiring.');

            } catch (error) {
                console.error('Send code error:', error);

                // Check if FloodWait error
                if (error.message.includes('A wait of')) {
                    const match = error.message.match(/A wait of (\d+) seconds/);
                    if (match) {
                        const waitSeconds = parseInt(match[1]);
                        const waitMinutes = Math.ceil(waitSeconds / 60);
                        alert(`‚è≥ Telegram FloodWait!\n\n` +
                              `Kutish kerak: ${waitMinutes} daqiqa (~${waitSeconds} sekund)\n\n` +
                              `Sabab: Juda ko'p marta SMS kod so'ragan bo'lsangiz.\n\n` +
                              `Yechim:\n` +
                              `1. ${waitMinutes} daqiqa kuting\n` +
                              `2. Yoki boshqa telefon raqam ishlating\n` +
                              `3. Yoki SSH orqali yarating:\n` +
                              `   ssh root@5.189.141.151\n` +
                              `   cd /var/www/dispatchr-logistics/backend\n` +
                              `   node create-session.js`);
                    } else {
                        alert('Xatolik: ' + error.message);
                    }
                } else {
                    alert('Xatolik: ' + error.message);
                }

                showLoading(false);
            }
        }

        async function verifyCode() {
            const code = document.getElementById('smsCode').value.trim();
            const password = document.getElementById('password2fa').value.trim();

            if (!code) {
                alert('SMS kodni kiriting!');
                return;
            }

            try {
                showLoading(true);

                const token = localStorage.getItem('token');
                const response = await fetch('/api/broadcast/session/create-step2', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ code, password })
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error);
                }

                // Store session string
                currentSessionString = data.sessionString;

                // Show step 3
                document.getElementById('accountName').textContent =
                    `${data.userInfo.firstName} ${data.userInfo.lastName || ''}`.trim();
                document.getElementById('accountPhone').textContent = data.userInfo.phone;
                document.getElementById('accountId').textContent = data.userInfo.id;

                document.getElementById('sessionStep1').style.display = 'none';
                document.getElementById('sessionStep2').style.display = 'none';
                document.getElementById('sessionStep3').style.display = 'block';
                document.getElementById('sessionLoading').style.display = 'none';

            } catch (error) {
                console.error('Verify code error:', error);
                alert('Xatolik: ' + error.message);
                showLoading(false);
                document.getElementById('sessionStep2').style.display = 'block';
            }
        }

        async function saveAndRestart() {
            if (!confirm('Session .env ga saqlanadi va PM2 restart qilinadi. Davom ettirasizmi?')) {
                return;
            }

            try {
                showLoading(true);

                const token = localStorage.getItem('token');

                // Save to .env
                const saveResponse = await fetch('/api/broadcast/session/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ sessionString: currentSessionString })
                });

                const saveData = await saveResponse.json();

                if (!saveData.success) {
                    throw new Error(saveData.error);
                }

                alert('‚úÖ Session saqlandi!\n\nEndi PM2 ni restart qilish kerak:\nssh root@5.189.141.151 "pm2 restart dispatchr-logistics"');

                // Close modal
                sessionModal.hide();

                // Reload page after 2 seconds
                setTimeout(() => {
                    window.location.reload();
                }, 2000);

            } catch (error) {
                console.error('Save session error:', error);
                alert('Xatolik: ' + error.message);
                showLoading(false);
                document.getElementById('sessionStep3').style.display = 'block';
            }
        }

        function backToStep1() {
            document.getElementById('sessionStep1').style.display = 'block';
            document.getElementById('sessionStep2').style.display = 'none';

            // Cancel session on backend
            const token = localStorage.getItem('token');
            fetch('/api/broadcast/session/cancel', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
        }

        // ============================================
        // SCHEDULED BROADCAST FUNCTIONS
        // ============================================

        async function addSchedule() {
            const message = document.getElementById('scheduledMessage').value;
            const interval = document.getElementById('scheduleInterval').value;
            const unit = document.getElementById('scheduleUnit').value;

            if (!message.trim()) {
                alert('Xabar matni kiriting!');
                return;
            }

            const cronExpression = `every:${interval}:${unit}`;

            const token = localStorage.getItem('token');
            const response = await fetch('/api/broadcast/schedule/create', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message,
                    cronExpression,
                    enabled: true
                })
            });

            const data = await response.json();

            if (data.success) {
                alert('‚úÖ Schedule qo\'shildi!');
                document.getElementById('scheduledMessage').value = '';
                loadSchedules();
            } else {
                alert('‚ùå Xatolik: ' + data.error);
            }
        }

        async function loadSchedules() {
            const token = localStorage.getItem('token');
            const response = await fetch('/api/broadcast/schedule/list', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            const data = await response.json();

            if (data.success) {
                const list = document.getElementById('schedulesList');
                if (data.schedules.length === 0) {
                    list.innerHTML = '<p class="text-muted">Rejalashtirilgan xabarlar yo\'q</p>';
                    return;
                }

                list.innerHTML = data.schedules.map(s => `
                    <div class="card mb-2">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <p class="mb-1"><strong>Xabar:</strong> ${s.message.substring(0, 100)}...</p>
                                    <p class="mb-1 text-muted">
                                        <i class="bi bi-clock"></i> ${s.cronExpression}
                                    </p>
                                    <p class="mb-0 text-success">
                                        <i class="bi bi-calendar-check"></i> Keyingi: ${new Date(s.nextRun).toLocaleString('uz-UZ')}
                                    </p>
                                </div>
                                <div>
                                    <div class="form-check form-switch mb-2">
                                        <input class="form-check-input" type="checkbox"
                                               ${s.enabled ? 'checked' : ''}
                                               onchange="toggleSchedule('${s.id}', this.checked)">
                                    </div>
                                    <button class="btn btn-sm btn-danger" onclick="deleteSchedule('${s.id}')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }

        async function toggleSchedule(id, enabled) {
            const token = localStorage.getItem('token');
            await fetch(`/api/broadcast/schedule/${id}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ enabled })
            });
            loadSchedules();
        }

        async function deleteSchedule(id) {
            if (!confirm('Rostdan o\'chirmoqchimisiz?')) return;

            const token = localStorage.getItem('token');
            await fetch(`/api/broadcast/schedule/${id}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            loadSchedules();
        }

        // ============================================
        // PRIVATE MESSAGE AUTO-REPLY FUNCTIONS
        // ============================================

        async function loadPrivateReply() {
            const token = localStorage.getItem('token');
            const response = await fetch('/api/broadcast/private-reply/settings', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            const data = await response.json();

            if (data.success) {
                document.getElementById('privateReplyEnabled').checked = data.settings.enabled;
                document.getElementById('privateReplyTemplate').value = data.settings.template;
                document.getElementById('repliedUsersCount').textContent = data.settings.repliedCount;
            }
        }

        async function savePrivateReply() {
            const enabled = document.getElementById('privateReplyEnabled').checked;
            const template = document.getElementById('privateReplyTemplate').value;

            const token = localStorage.getItem('token');
            const response = await fetch('/api/broadcast/private-reply/update', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ enabled, template })
            });

            const data = await response.json();

            if (data.success) {
                alert('‚úÖ Saqlandi!');
                loadPrivateReply();
            } else {
                alert('‚ùå Xatolik: ' + data.error);
            }
        }

        function loadDefaultTemplate() {
            const defaultTemplate = `Assalomu alaykum! üëã

üöõ Siz bizning DISPETCHERLAR uchun mo'ljallangan guruhimizga xabar yubordingiz!

üì¢ Bizning asosiy guruhimiz: @yoldauz

‚úÖ Bu guruh O'ZBEKISTON va XALQARO LOGISTIKA bo'yicha eng yaxshi va ishonchli platformalardan biri!

üåü Nima uchun bizning guruhga qo'shilishingiz kerak:
   ‚Ä¢ 100+ faol guruhlardan e'lonlar
   ‚Ä¢ AI filtrlangan SIFATLI yuklar
   ‚Ä¢ Dispetcher spamidan tozalangan
   ‚Ä¢ Tez javob va professional yondashuv

üë• Guruhga qo'shiling: @yoldauz

üìû Savol-javob uchun: @admin_username

Muvaffaqiyatli yuklaringiz bo'lsin! üöÄ`;
            document.getElementById('privateReplyTemplate').value = defaultTemplate;
        }

        async function clearRepliedUsers() {
            if (!confirm('Javob berilgan userlar ro\'yxatini tozalamoqchimisiz?')) return;

            const token = localStorage.getItem('token');
            const response = await fetch('/api/broadcast/private-reply/clear', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            const data = await response.json();
            if (data.success) {
                alert('‚úÖ Tozalandi!');
                loadPrivateReply();
            }
        }

        // ============================================
        // SESSION MANAGEMENT FUNCTIONS
        // ============================================

        async function deleteSession() {
            if (!confirm('‚ö†Ô∏è DIQQAT!\n\nSession o\'chiriladi va barcha funksiyalar to\'xtaydi:\n- Auto-reply\n- Broadcast\n- Scheduled messages\n\nRostdan o\'chirmoqchimisiz?')) {
                return;
            }

            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/broadcast/session/delete', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    alert('‚úÖ Session o\'chirildi!\n\nTizim qayta ishga tushirilmoqda...');

                    // Update UI immediately to show disconnected state
                    updateSessionStatus({ isConnected: false });

                    // Wait 5 seconds for restart, then reload
                    setTimeout(() => {
                        window.location.reload();
                    }, 5000);
                } else {
                    alert('‚ùå Xatolik: ' + data.error);
                }

            } catch (error) {
                console.error('Session delete error:', error);
                alert('‚ùå Session o\'chirishda xatolik: ' + error.message);
            }
        }

        async function restartSession() {
            if (!confirm('Session qayta ishga tushirilsinmi?')) return;

            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/broadcast/session/restart', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    alert('‚úÖ Session qayta ishga tushirilmoqda...');

                    // Wait 3 seconds for restart
                    setTimeout(() => {
                        window.location.reload();
                    }, 3000);
                } else {
                    alert('‚ùå Xatolik: ' + data.error);
                }

            } catch (error) {
                console.error('Session restart error:', error);
                alert('‚ùå Session qayta ishga tushirishda xatolik: ' + error.message);
            }
        }

        // Load on tab switch
        document.getElementById('scheduled-tab').addEventListener('click', loadSchedules);
        document.getElementById('private-tab').addEventListener('click', loadPrivateReply);

    </script>
</body>
</html>
