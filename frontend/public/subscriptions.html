<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Obunalar Boshqaruvi</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    .stat-card {
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .stat-card.green {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }

    .stat-card.orange {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .stat-card.blue {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .subscription-badge {
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
      border-radius: 6px;
    }

    .badge-trial {
      background: #17a2b8;
    }

    .badge-weekly {
      background: #28a745;
    }

    .badge-monthly {
      background: #007bff;
    }

    .badge-grandfather {
      background: #ffc107;
      color: #000;
    }

    .vip-badge {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 6px;
      font-size: 0.75rem;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="/dashboard.html">
        <i class="bi bi-truck"></i> Logistics System
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="/dashboard.html">
              <i class="bi bi-speedometer2"></i> Dashboard
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="/subscriptions.html">
              <i class="bi bi-credit-card"></i> Obunalar
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/vip.html">
              <i class="bi bi-star-fill"></i> VIP A'zolar
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" onclick="logout()">
              <i class="bi bi-box-arrow-right"></i> Chiqish
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container-fluid mt-4">
    <!-- Statistics Cards -->
    <div class="row mb-4">
      <div class="col-md-3">
        <div class="stat-card">
          <h6><i class="bi bi-people"></i> Jami Obunalar</h6>
          <h2 id="totalSubscriptions">0</h2>
          <small>Barcha vaqt</small>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stat-card green">
          <h6><i class="bi bi-check-circle"></i> Aktiv Obunalar</h6>
          <h2 id="activeSubscriptions">0</h2>
          <small>Hozir faol</small>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stat-card orange">
          <h6><i class="bi bi-star-fill"></i> VIP A'zolar</h6>
          <h2 id="vipCount">0 / 100</h2>
          <small id="vipRemaining">100 joy qolgan</small>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stat-card blue">
          <h6><i class="bi bi-currency-dollar"></i> 30 kunlik daromad</h6>
          <h2 id="revenue30days">0 so'm</h2>
          <small>Oxirgi oy</small>
        </div>
      </div>
    </div>

    <!-- Filters and Actions -->
    <div class="card mb-4">
      <div class="card-body">
        <div class="row">
          <div class="col-md-3">
            <select class="form-select" id="filterPlanType">
              <option value="">Barcha rejalar</option>
              <option value="trial">Trial</option>
              <option value="weekly">Haftalik</option>
              <option value="monthly">Oylik</option>
              <option value="grandfather">Grandfather</option>
            </select>
          </div>
          <div class="col-md-3">
            <select class="form-select" id="filterStatus">
              <option value="">Barcha status</option>
              <option value="true">Aktiv</option>
              <option value="false">Nofaol</option>
            </select>
          </div>
          <div class="col-md-3">
            <button class="btn btn-primary w-100" onclick="loadSubscriptions()">
              <i class="bi bi-search"></i> Qidirish
            </button>
          </div>
          <div class="col-md-3">
            <button class="btn btn-success w-100" data-bs-toggle="modal" data-bs-target="#createSubscriptionModal">
              <i class="bi bi-plus-circle"></i> Yangi Obuna
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Subscriptions Table -->
    <div class="card">
      <div class="card-header">
        <h5><i class="bi bi-list-ul"></i> Obunalar Ro'yxati</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>ID</th>
                <th>Foydalanuvchi</th>
                <th>Reja</th>
                <th>Boshlangan</th>
                <th>Tugaydi</th>
                <th>To'lov</th>
                <th>Status</th>
                <th>Amallar</th>
              </tr>
            </thead>
            <tbody id="subscriptionsTable">
              <tr>
                <td colspan="8" class="text-center">
                  <div class="spinner-border" role="status">
                    <span class="visually-hidden">Yuklanmoqda...</span>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Subscription Modal -->
  <div class="modal fade" id="createSubscriptionModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Yangi Obuna Yaratish</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="createSubscriptionForm">
            <div class="mb-3">
              <label class="form-label">Telegram User ID</label>
              <input type="text" class="form-control" name="telegram_user_id" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Username</label>
              <input type="text" class="form-control" name="username">
            </div>
            <div class="mb-3">
              <label class="form-label">To'liq ism</label>
              <input type="text" class="form-control" name="full_name">
            </div>
            <div class="mb-3">
              <label class="form-label">Reja turi</label>
              <select class="form-select" name="plan_type" required>
                <option value="trial">Trial (1 kun)</option>
                <option value="weekly">Haftalik (7 kun)</option>
                <option value="monthly">Oylik (30 kun)</option>
                <option value="grandfather">Grandfather (cheksiz)</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">To'lov usuli</label>
              <select class="form-select" name="payment_method">
                <option value="free">Bepul</option>
                <option value="click">Click</option>
                <option value="payme">Payme</option>
                <option value="balance">Balans</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">To'langan summa (so'm)</label>
              <input type="number" class="form-control" name="amount_paid" value="0">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Yopish</button>
          <button type="button" class="btn btn-primary" onclick="createSubscription()">Yaratish</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Extend Subscription Modal -->
  <div class="modal fade" id="extendModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Obunani Uzaytirish</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="extendForm">
            <input type="hidden" id="extendSubId">
            <div class="mb-3">
              <label class="form-label">Necha kunga uzaytirish?</label>
              <input type="number" class="form-control" id="extendDays" min="1" value="7" required>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Yopish</button>
          <button type="button" class="btn btn-primary" onclick="extendSubscription()">Uzaytirish</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const API_BASE = '/api';

    // Check auth
    const token = localStorage.getItem('token');
    if (!token) {
      window.location.href = '/index.html';
    }

    // Load statistics and subscriptions on page load
    document.addEventListener('DOMContentLoaded', () => {
      loadStatistics();
      loadSubscriptions();
    });

    async function loadStatistics() {
      try {
        const response = await fetch(`${API_BASE}/subscriptions/statistics`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        const data = await response.json();

        if (data.success) {
          const { subscriptions, vip, referrals } = data.statistics;

          document.getElementById('totalSubscriptions').textContent = subscriptions.total_subscriptions;
          document.getElementById('activeSubscriptions').textContent = subscriptions.active_subscriptions;
          document.getElementById('vipCount').textContent = `${vip.total_vip} / 100`;
          document.getElementById('vipRemaining').textContent = `${vip.remaining_slots} joy qolgan`;
          document.getElementById('revenue30days').textContent = `${subscriptions.revenue_30days.toLocaleString()} so'm`;
        }
      } catch (error) {
        console.error('Statistics load error:', error);
      }
    }

    async function loadSubscriptions() {
      const planType = document.getElementById('filterPlanType').value;
      const isActive = document.getElementById('filterStatus').value;

      let url = `${API_BASE}/subscriptions?limit=100`;

      if (planType) url += `&plan_type=${planType}`;
      if (isActive) url += `&is_active=${isActive}`;

      try {
        const response = await fetch(url, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        const data = await response.json();

        if (data.success) {
          renderSubscriptions(data.subscriptions);
        }
      } catch (error) {
        console.error('Subscriptions load error:', error);
      }
    }

    function renderSubscriptions(subscriptions) {
      const tbody = document.getElementById('subscriptionsTable');

      if (subscriptions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center">Obunalar topilmadi</td></tr>';
        return;
      }

      tbody.innerHTML = subscriptions.map(sub => {
        const startDate = new Date(sub.start_date).toLocaleDateString('uz-UZ');
        const endDate = new Date(sub.end_date).toLocaleDateString('uz-UZ');
        const isExpired = new Date(sub.end_date) < new Date();
        const badgeClass = `badge-${sub.plan_type}`;

        return `
          <tr>
            <td>${sub.id}</td>
            <td>
              <strong>${sub.full_name || 'N/A'}</strong><br>
              <small class="text-muted">@${sub.username || 'N/A'}</small><br>
              <small class="text-muted">${sub.telegram_user_id}</small>
            </td>
            <td><span class="subscription-badge ${badgeClass}">${sub.plan_type}</span></td>
            <td>${startDate}</td>
            <td>${endDate}</td>
            <td>${sub.amount_paid.toLocaleString()} so'm</td>
            <td>
              ${sub.is_active && !isExpired
                ? '<span class="badge bg-success">Aktiv</span>'
                : '<span class="badge bg-danger">Nofaol</span>'}
            </td>
            <td>
              <button class="btn btn-sm btn-primary" onclick="openExtendModal(${sub.id})" title="Uzaytirish">
                <i class="bi bi-calendar-plus"></i>
              </button>
              ${sub.is_active
                ? `<button class="btn btn-sm btn-danger" onclick="deactivateSubscription(${sub.id})" title="Deaktiv qilish">
                    <i class="bi bi-x-circle"></i>
                  </button>`
                : ''}
            </td>
          </tr>
        `;
      }).join('');
    }

    async function createSubscription() {
      const form = document.getElementById('createSubscriptionForm');
      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());

      try {
        const response = await fetch(`${API_BASE}/subscriptions`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.success) {
          alert('Obuna yaratildi!');
          bootstrap.Modal.getInstance(document.getElementById('createSubscriptionModal')).hide();
          form.reset();
          loadStatistics();
          loadSubscriptions();
        } else {
          alert('Xatolik: ' + result.error);
        }
      } catch (error) {
        console.error('Create subscription error:', error);
        alert('Xatolik yuz berdi');
      }
    }

    function openExtendModal(subId) {
      document.getElementById('extendSubId').value = subId;
      new bootstrap.Modal(document.getElementById('extendModal')).show();
    }

    async function extendSubscription() {
      const subId = document.getElementById('extendSubId').value;
      const days = document.getElementById('extendDays').value;

      try {
        const response = await fetch(`${API_BASE}/subscriptions/${subId}/extend`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ days: parseInt(days) })
        });

        const result = await response.json();

        if (result.success) {
          alert(`Obuna ${days} kunga uzaytirildi!`);
          bootstrap.Modal.getInstance(document.getElementById('extendModal')).hide();
          loadSubscriptions();
        } else {
          alert('Xatolik: ' + result.error);
        }
      } catch (error) {
        console.error('Extend subscription error:', error);
        alert('Xatolik yuz berdi');
      }
    }

    async function deactivateSubscription(subId) {
      if (!confirm('Obunani deaktiv qilmoqchimisiz?')) return;

      try {
        const response = await fetch(`${API_BASE}/subscriptions/${subId}/deactivate`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        const result = await response.json();

        if (result.success) {
          alert('Obuna deaktiv qilindi!');
          loadSubscriptions();
        } else {
          alert('Xatolik: ' + result.error);
        }
      } catch (error) {
        console.error('Deactivate subscription error:', error);
        alert('Xatolik yuz berdi');
      }
    }

    function logout() {
      localStorage.removeItem('token');
      window.location.href = '/index.html';
    }
  </script>
</body>
</html>
